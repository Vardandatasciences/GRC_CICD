name: Deploy Frontend to EC2

# =============================================================================
# WHEN TO RUN THIS WORKFLOW
# =============================================================================
on:
  push:
    branches:
      - main      # Change to 'master' if your default branch is master
      - develop   # Optional: deploy develop branch too
    paths:
      - 'frontend/**'  # Only trigger when frontend files change
  workflow_dispatch:  # Allow manual triggering from GitHub UI

# =============================================================================
# ENVIRONMENT VARIABLES (Set these in GitHub Secrets if needed)
# =============================================================================
env:
  DOCKER_IMAGE_NAME: frontend-grc
  DOCKER_CONTAINER_NAME: frontend-grc-container
  DOCKER_PORT: 8080

# =============================================================================
# JOBS - What the workflow will do
# =============================================================================
jobs:
  deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: self-hosted  # Uses your self-hosted runner on EC2
    
    steps:
      # ---------------------------------------------------------------------
      # Step 1: Checkout the code
      # ---------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better git info

      # ---------------------------------------------------------------------
      # Step 2: Set up Docker Buildx (for better caching and multi-platform)
      # ---------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---------------------------------------------------------------------
      # Step 3: Navigate to frontend directory
      # ---------------------------------------------------------------------
      - name: Navigate to frontend directory
        run: |
          cd frontend
          pwd
          ls -la

      # ---------------------------------------------------------------------
      # Step 4: Build Docker image
      # ---------------------------------------------------------------------
      - name: Build Docker image
        working-directory: ./frontend
        run: |
          echo "Building Docker image: ${{ env.DOCKER_IMAGE_NAME }}"
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:latest .
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} .
          echo "Docker image built successfully!"

      # ---------------------------------------------------------------------
      # Step 5: Stop and remove old container (if exists)
      # ---------------------------------------------------------------------
      - name: Stop old container
        run: |
          if [ "$(docker ps -aq -f name=${{ env.DOCKER_CONTAINER_NAME }})" ]; then
            echo "Stopping and removing old container..."
            docker stop ${{ env.DOCKER_CONTAINER_NAME }} || true
            docker rm ${{ env.DOCKER_CONTAINER_NAME }} || true
            echo "Old container removed!"
          else
            echo "No existing container found."
          fi

      # ---------------------------------------------------------------------
      # Step 6: Run new container
      # ---------------------------------------------------------------------
      - name: Run new container
        run: |
          echo "Starting new container..."
          docker run -d \
            --name ${{ env.DOCKER_CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ env.DOCKER_PORT }}:80 \
            ${{ env.DOCKER_IMAGE_NAME }}:latest
          echo "Container started successfully!"

      # ---------------------------------------------------------------------
      # Step 7: Health check
      # ---------------------------------------------------------------------
      - name: Health check
        run: |
          echo "Waiting for container to be ready..."
          sleep 5
          
          # Check if container is running
          if docker ps | grep -q ${{ env.DOCKER_CONTAINER_NAME }}; then
            echo "‚úÖ Container is running!"
            docker ps | grep ${{ env.DOCKER_CONTAINER_NAME }}
          else
            echo "‚ùå Container failed to start!"
            docker logs ${{ env.DOCKER_CONTAINER_NAME }}
            exit 1
          fi
          
          # Optional: Test HTTP endpoint
          echo "Testing HTTP endpoint..."
          curl -f http://localhost:${{ env.DOCKER_PORT }} || echo "Warning: HTTP check failed (might be normal if nginx needs time)"

      # ---------------------------------------------------------------------
      # Step 8: Clean up old images (optional - saves disk space)
      # ---------------------------------------------------------------------
      - name: Clean up old Docker images
        run: |
          echo "Cleaning up old Docker images..."
          # Remove dangling images
          docker image prune -f
          # Keep only last 3 versions
          docker images ${{ env.DOCKER_IMAGE_NAME }} --format "{{.ID}} {{.Tag}}" | \
            tail -n +4 | \
            awk '{print $1}' | \
            xargs -r docker rmi || true
          echo "Cleanup completed!"

      # ---------------------------------------------------------------------
      # Step 9: Show deployment summary
      # ---------------------------------------------------------------------
      - name: Deployment summary
        run: |
          echo "=========================================="
          echo "üöÄ Deployment Summary"
          echo "=========================================="
          echo "Image: ${{ env.DOCKER_IMAGE_NAME }}:latest"
          echo "Container: ${{ env.DOCKER_CONTAINER_NAME }}"
          echo "Port: ${{ env.DOCKER_PORT }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "=========================================="
          docker ps --filter "name=${{ env.DOCKER_CONTAINER_NAME }}"
          echo "=========================================="

